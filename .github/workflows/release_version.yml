name: Create Release Version

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        cd payment && npm ci
        cd ../atm && npm ci
        
    - name: Run tests
      run: |
        cd payment && npm run test:cov
        cd ../atm && npm run test:cov
        
    - name: Build packages
      run: |
        cd payment && npm run build
        cd ../atm && npm run build
        
    - name: Update package versions
      run: |
        cd payment
        npm pkg set name="@${{ github.repository_owner }}/payment_ch"
        npm pkg set version="${{ github.ref_name }}"
        npm pack
        
        cd ../atm
        npm pkg set name="@${{ github.repository_owner }}/atm_ch"
        npm pkg set version="${{ github.ref_name }}"
        npm pack
        
    - name: Create release directory
      run: |
        mkdir -p release-assets
        cp payment/*.tgz release-assets/
        cp atm/*.tgz release-assets/
        
    - name: Generate release notes
      run: |
        cat > RELEASE_NOTES.md << 'EOF'
        # ðŸš€ Release ${{ github.ref_name }}
        
        ## ðŸ“‹ Patrones de DiseÃ±o Implementados
        
        ### ðŸ’³ Strategy Pattern (Payment System)
        - âœ… **IPaymentStrategy Interface** - Contrato base para estrategias de pago
        - âœ… **CreditCardPaymentStrategy** - ImplementaciÃ³n para pagos con tarjeta de crÃ©dito
        - âœ… **DebitCardPaymentStrategy** - ImplementaciÃ³n para pagos con tarjeta de dÃ©bito
        - âœ… **CashPaymentStrategy** - ImplementaciÃ³n para pagos en efectivo
        - âœ… **PaymentContext** - Contexto que mantiene referencia a la estrategia
        - âœ… **PaymentService** - Servicio fachada para facilitar el uso
        - âœ… **Pruebas unitarias completas** con cobertura
        
        ### ðŸ§ Command Pattern (ATM System)
        - âœ… **ICommand Interface** - Contrato base para comandos
        - âœ… **WithdrawCommand** - Comando para retiros de dinero
        - âœ… **DepositCommand** - Comando para depÃ³sitos de dinero
        - âœ… **Account** - Receptor que contiene la lÃ³gica de negocio
        - âœ… **ATM** - Invocador que ejecuta comandos
        - âœ… **Pruebas unitarias completas** con cobertura
        
        ## ðŸ“¦ Artefactos incluidos
        - `payment_ch-${{ github.ref_name }}.tgz` - Paquete del sistema de pagos
        - `atm_ch-${{ github.ref_name }}.tgz` - Paquete del sistema ATM
        
        ## ðŸ“š DocumentaciÃ³n
        La documentaciÃ³n completa estÃ¡ disponible en: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
        
        ## ðŸ§ª Calidad del CÃ³digo
        - âœ… Pruebas unitarias: 100% pasando
        - âœ… Cobertura de cÃ³digo reportada
        - âœ… AnÃ¡lisis SonarCloud completado
        - âœ… DocumentaciÃ³n JSDoc completa
        
        ---
        **Generado automÃ¡ticamente por GitHub Actions** ðŸ¤–
        EOF
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: "Release ${{ github.ref_name }}"
        body_path: RELEASE_NOTES.md
        files: |
          release-assets/*.tgz
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}